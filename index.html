<html>
<head>
<script src="js/jquery-3.3.1.min.js"></script>
<script src="js/jquery-ui.min.js"></script>

<link rel="stylesheet" type="text/css" media="all" href="css/style.css">
<link rel="stylesheet" type="text/css" media="all" href="css/pretty-checkbox.min.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
<link rel="stylesheet" href="https:////cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css">
<link rel="stylesheet" type="text/css" media="all" href="css/leaflet.awesome-markers.css">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
  <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.35.1/mapbox-gl.css" rel='stylesheet' />
  <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.35.1/mapbox-gl.js"></script>
  <script src="http://rawgit.com/mapbox/mapbox-gl-leaflet/master/leaflet-mapbox-gl.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.3.1/gpx.min.js"></script></head>
<script src="js/leaflet.awesome-markers.min.js"></script>
<script src="http://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
<body>
	<button type="submit" onclick="UserAction()">Search</button>
	<table id="example"></div>

	<h1>Slovenia Holiday</h1>

	<div id="days">
		<div class="day">
			<div class="arrowdown">
				<h2>Day 1</h2>
				<div id="arrow">
					<h2>&rarr;</h2>
				</div>
			</div>
			<div style="clear: both"></div>
			<div class="contentelem">
				<p>klasdjflaksdjf</p>
				<p>jklasdfjlasdf</p>
			</div>
		</div>

	</div>
	<div id="highlights">
		<h2>Highlights</h2>
		<ul>
		</ul>
	</div>

	<div id="routes">
		<h2>Fahrrad - Routen</h2>
		<ul>
			<li><div class='pretty p-switch p-slim' onclick='addRoute(this)'
					data-file='./kml/bergroute.gpx'>
					<input type='checkbox' checked />
					<div class='state'>
						<label>Bergroute</label>
					</div>
				</div></li>
			<li><div class='pretty p-switch p-slim' onclick='addRoute(this)'
					data-file='./kml/lj-pi.gpx'>
					<input type='checkbox' />
					<div class='state'>
						<label>Ljubljana - Piran</label>
					</div>
				</div></li>
			<li><div class='pretty p-switch p-slim' onclick='addRoute(this)'
					data-file='./kml/Krajna.gpx'  data-width='3'>
					<input type='checkbox' checked />
					<div class='state'>
						<label>Rund um Krajna (43 km, 900Hm)</label>
					</div>
				</div></li>
			<li><div class='pretty p-switch p-slim' onclick='addRoute(this)'
					data-file='./kml/Kras1.gpx' data-width='2'>
					<input type='checkbox' checked />
					<div class='state'>
						<label>Kras 1 (83km, 900Hm)</label>
					</div>
				</div></li>
			<li><div class='pretty p-switch p-slim' onclick='addRoute(this)'
					data-file='./kml/Kras_short.gpx'  data-width='1'>
					<input type='checkbox'  />
					<div class='state'>
						<label>Kras kurz (57 km, 700Hm)</label>
					</div>
				</div></li>
		</ul>
	</div>
	<div id="trains">
		<h2>Z&uuml;ge</h2>
		<ul>
			<li><div class='pretty p-switch p-slim' onclick='addTrain(this)'
					data-file='./kml/lj-pi-train.gpx'>
					<input type='checkbox' checked />
					<div class='state'>
						<label>Ljubljana - Koper Zug</label>
					</div>
				</div></li>
			<li><div class='pretty p-switch p-slim' onclick='addTrain(this)'
					data-file='./kml/lj-js-train.gpx'>
					<input type='checkbox' checked />
					<div class='state'>
						<label>Ljubljana - Jesenice Zug</label>
					</div>
				</div></li>

			<li><div class='pretty p-switch p-slim' onclick='addTrain(this)'
					data-file='./kml/most-train.gpx'>
					<input type='checkbox' checked />
					<div class='state'>
						<label>Bohinjska Bistrica - Most na Soci* - Sezana -
							Presnica Zug</label>
					</div>
				</div></li>
		</ul>
	</div>
	<div id="mapcontrol">Hide Map</div>
	<div id="mapwrapper" class="active">
		<div id="mapid"></div>
	</div>



	<script type="text/javascript">

	// Show or hide the content of a day using the arrowdown element
	$(".arrowdown").click(function(e) {
		$(this).parent().find(".contentelem").each(function(elem) {
			if ($(this).is(':visible')) {
				$(this).hide();
			} else {

				$(this).show();
			}
		})
		$(this).toggleClass("rotated");

	})

	// Show or hide the map
	$("#mapcontrol").click(function(e) {
		if ($("#mapwrapper").hasClass("active")) {
			$(this).text("Show map");
		} else {
			$(this).text("Hide map");
		}
		$("#mapwrapper").toggleClass("active");

	})

	var mymap = L.map('mapid').setView([45.990623, 13.909995 ], 9);
	var mapRoutes = [];
	var mapTrains = [];
	var mapMarkers = [];

	// Add a basic map to the view "mymap"
	L.tileLayer(
					'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}',
					{
						attribution : 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery ? <a href="https://www.mapbox.com/">Mapbox</a>',
						maxZoom : 18,
						id : 'mapbox.streets',
						accessToken : 'pk.eyJ1IjoiemFwcGluZ3NlYiIsImEiOiJjaW14a2lhdTYwMGRmd2VtMmZhY2h0N2JtIn0.B3apneYn9eDwyl7x2gP0Og'
					}).addTo(mymap);

	// Backend for highlights stored in GDrive
	// Get the Spreadsheet containing all highlights and add for each
	// Highlight an on/off switch
	$.getJSON(
					"https://spreadsheets.google.com/feeds/list/18RNz9xkD-cCadsKuPFw9-Y6r7MimFIgarJtkg27TK2U/1/public/values?alt=json",
					function(data) {
						
						
						//first row "title" column
						for (i = 0; i < data.feed.entry.length; i++) {
							if(data.feed.entry[i]['gsx$image']['$t']==""){
								image_link=""
							}else{
								var pattern = /((http|https|ftp|data\:image).*)/;
								if(pattern.test(data.feed.entry[i]['gsx$image']['$t'])){
									
									image_link  = "<div class='image'><img src='"+data.feed.entry[i]['gsx$image']['$t']+"'/>" + 
										"<br/><a style='font-size:4px;color:#e2e2e2'>from: "+data.feed.entry[i]['gsx$image']['$t']+"</a>"+
										"</div>"
									
								}else{
									
									image_link  = "<div class='image'><img src='./img/"+data.feed.entry[i]['gsx$image']['$t']+"'/></div>"
								}
							}
							
							
							$("#highlights ul")
									.append(
											"<li>"+
											"<div class='highlight'>"+
											"<div class='pretty p-switch p-slim' onclick='addmarker(this)' href='#' data-long='"
														+
														// Get the Longitudinal and Latitudinal coordinates of the Highlight
														data.feed.entry[i]['gsx$long']['$t']
														+ "' data-lat='"
														+ data.feed.entry[i]['gsx$lat']['$t']
														+ "' data-name='"
														+ data.feed.entry[i]['gsx$ort']['$t']
														+ "' data-icon='"
														+ data.feed.entry[i]['gsx$typ']['$t']
														+ "'>"
														+ "<input type='checkbox' /><div class='state'><label>"
														+
														// Insert the name (Ort) of the field
														data.feed.entry[i]['gsx$ort']['$t']
														+ "</label></div></div>"
														
														+ "<br/>"+image_link+"<br/><p>"+
														data.feed.entry[i]['gsx$description']['$t']
														+"</p>"+
														"</div></li>")
							}
		});

		// function to add a marker element to the map
		addmarker = function(element) {

			for (var i = 0; i < mapMarkers.length; i++) {
				mymap.removeLayer(mapMarkers[i]);
			}

			$(element).parent().parent().parent().find("div.pretty").each(
					function(e) {

						if ($(this).find("input").is(":checked")) {
							marker =
								L.marker(
									[ this.getAttribute("data-long"),
											this.getAttribute("data-lat") ],
								{icon:L.AwesomeMarkers.icon({
								    icon: this.getAttribute("data-icon"),
								    markerColor: 'red',
								    prefix: 'fa'
								  })}			
								).bindPopup(this.getAttribute("data-name"))
								.addTo(mymap);
							mapMarkers.push(marker);
						}
					})

		}

		// function to add sth to the layer route
		addRoute = function(element) {

			for (var i = 0; i < mapRoutes.length; i++) {
				mymap.removeLayer(mapRoutes[i]);
			}

			$(element).parent().parent().find("div.pretty").each(function(e) {

				if ($(this).find("input").is(":checked")) {
					if(this.getAttribute("data-width")==null){
						dasharray = '1,1';
						datawidth = "3"
					}else{
						dasharray = [this.getAttribute("data-width")*6,'20'].join(",");
						datawidth = this.getAttribute("data-width")
					}
					
					route = new L.GPX(this.getAttribute("data-file"), {
						async : true,
						marker_options: {
						    startIconUrl: '',
						    endIconUrl: '',
						    shadowUrl: ''
						  },
						  polyline_options : {
								weight: datawidth ,
								dashArray: dasharray
						  }
					}).addTo(mymap,{autopan:false})
					mapRoutes.push(route);

				}
			})
		}
		// Function to add sth to the layer train
		addTrain = function(element) {

			for (var i = 0; i < mapTrains.length; i++) {
				mymap.removeLayer(mapTrains[i]);
			}

			$(element).parent().parent().find("div.pretty").each(function(e) {

				if ($(this).find("input").is(":checked")) {
					train = new L.GPX(this.getAttribute("data-file"), {
						async : true,
						polyline_options : {
							color : 'green'
						},
						marker_options: {
						    startIconUrl: '',
						    endIconUrl: '',
						    shadowUrl: ''
						  }
					}).addTo(mymap,{autopan:false})
					mapTrains.push(train);
				}
			})
		}
		function UserAction() {
		    var xhttp = new XMLHttpRequest();
		    var api_key = "";
		    $.ajax({url: './api_key.txt',
            type: 'get',
            async: false,
            success: function(html) {
            	var twig = String(html);
            	api_key = api_key + twig
            }
		    })
		    $.getJSON( "https://api.openrouteservice.org/directions?api_key="+
	    		api_key
	    		+"&coordinates=8.34234%2C48.23424%7C8.34423%2C48.26424&profile=driving-car&format=json",
	    		function( data ) {
		    	  var items = [];
		    	  $.each( data, function( key, val ) {
		    	    alert(key)
		    	  });
		    	 
		    	});
		}//UserAction
		
		// Start showing Routes and trains
		$(document).ready(function(e) {

			$("#routes").find("div.pretty").each(function(e) {
				addRoute(this)
			});
			$("#trains").find("div.pretty").each(function(e) {
				addTrain(this)
			});
			var events = $('#events');
			var table = $('#example').DataTable( {
				"bServerSide":false,
				"paging":false,
				"serverSide": true,
				"bProcessing":true,
				"sAjaxDataProp": "feed.entry",
				"sAjaxSource": "https://spreadsheets.google.com/feeds/list/18RNz9xkD-cCadsKuPFw9-Y6r7MimFIgarJtkg27TK2U/2/public/values?alt=json",
				"aoColumns": [
				{ "mDataProp": "gsx$day.$t" },
				{ "mDataProp": "gsx$name.$t" },
				{ "mDataProp": "gsx$lat.$t" },
				{ "mDataProp": "gsx$long.$t" },
				],
				"columnDefs": [
				               { "title": "Tag", "targets": 0 },
				               { "title": "Name", "targets": 0 },
				               { "title": "Lat", "targets": 1 },
				               { "title": "Long", "targets": 2 }
				             ]	
			});
			$('#example tbody').on( 'click', 'tr', function () {
				if ( $(this).hasClass('selected') ) {
		            $(this).removeClass('selected');
		        }
		        else {
		            table.$('tr.selected').removeClass('selected');
		            $(this).addClass('selected');
		        }
		    } );
			table.on( 'select', function ( e, dt, type, indexes ) {
	            var rowData = table.rows( indexes ).data().toArray();
	            events.prepend( '<div><b>'+type+' selection</b> - '+JSON.stringify( rowData )+'</div>' );
	        } )
	        
			mymap.setView([ 45.990623, 13.909995 ], 9);
		});
	</script>
</body>
</html>